<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargar Excel con Cabeceras Fijas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .container { max-width: 1200px; margin-top: 50px; } /* Ajuste de ancho para más columnas */
        #loadingSpinner { display: none; } /* Ocultar por defecto */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; position: sticky; top: 0; } /* Encabezados fijos al hacer scroll */
        .table-container { max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; } /* Contenedor con scroll para la tabla */
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="container">
        <h1 class="mb-4">Cargar Archivo Excel/CSV con Cabeceras Fijas</h1>

        <div class="mb-3">
            <label for="input_excel" class="form-label">Selecciona un archivo:</label>
            <input type="file" name="archivo_excel" id="input_excel" accept=".xlsx,.xls,.csv" class="form-control mb-3">
            <small class="form-text text-muted">Archivos soportados: .xlsx, .xls, .csv</small>
        </div>

        <button id="load_button" class="btn btn-primary mb-3">Cargar Información</button>
        <button id="guardar-btn" class="btn btn-primary mb-3">Guardar Información</button>
        <div id="loadingSpinner" class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>

        <div id="error_message" class="mt-4 text-danger">
        </div>

        <!-- <div class="table-container mt-4"> -->
            <table class="table table-striped table-bordered" id="tabla-datos">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Número</th>
                        <th>CI/RUC</th>
                        <th>Partner</th>
                        <th>Tip. Doc.</th>
                        <th>Subtotal</th>
                        <th>Base 0%</th>
                        <th>Base no obj</th>
                        <th>Base ex.</th>
                        <th>Base Iva</th>
                        <th>Base Ice</th>
                        <th>IVA</th>
                        <th>ICE</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="excel_table_body">
                    </tbody>
            </table>
        <!-- </div> -->
    </div>

    <script>
        // Obtener referencias a los elementos HTML
        const inputExcel = document.getElementById('input_excel');
        const loadButton = document.getElementById('load_button');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const excelTableBody = document.getElementById('excel_table_body'); // Referencia al tbody
        const errorMessageDiv = document.getElementById('error_message');

        loadButton.addEventListener('click', async function() {
            const file = inputExcel.files[0];

            // Limpiar mensajes de error y el cuerpo de la tabla
            excelTableBody.innerHTML = '';
            errorMessageDiv.innerHTML = '';

            if (file) {
                loadingSpinner.style.display = 'block';

                const formData = new FormData();
                formData.append('archivo_excel', file);

                try {
                    const response = await fetch('/api/upload_excel/', {
                        method: 'POST',
                        body: formData,
                        // Si estás usando CSRF en Django, no olvides incluir el token:
                        // headers: {
                        //     'X-CSRFToken': getCookie('csrftoken'),
                        // },
                    });

                    loadingSpinner.style.display = 'none';

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error desconocido del servidor.');
                    }

                    const data = await response.json(); // Los datos procesados del Excel

                    if (data.length > 0) {
                        let rowsHTML = '';
                        // Itera sobre los datos para construir las filas del <tbody>
                        data.forEach(row => {
                            rowsHTML += '<tr>';
                            i = 0; // Contador para manejar las cabeceras fijas
                            row.forEach(cell => {
                                // Asegúrate de que el número de celdas en la fila coincida con el número de cabeceras.
                                // Si hay menos o más datos en una fila del Excel, esto podría descuadrar la tabla.
                                if (i === 0) {
                                    // Si es la primera columna (Fecha), intenta formatear la fecha y hora
                                    let formattedDateTime = '';
                                    if (cell) {
                                        // Intenta parsear la fecha (soporta formatos ISO y dd/mm/yyyy HH:mm:ss)
                                        const dateObj = new Date(cell);
                                        if (!isNaN(dateObj.getTime())) {
                                            // Formato: dd/mm/yyyy HH:mm:ss
                                            const datePart = dateObj.toLocaleDateString('es-EC');
                                            const timePart = dateObj.toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                            formattedDateTime = `${datePart} ${timePart}`;
                                        } else if (typeof cell === 'string' && cell.match(/^\d{2}\/\d{2}\/\d{4}( \d{2}:\d{2}(:\d{2})?)?$/)) {
                                            // Ya está en formato dd/mm/yyyy o dd/mm/yyyy HH:mm:ss
                                            formattedDateTime = cell;
                                        } else {
                                            formattedDateTime = cell;
                                        }
                                    }
                                    rowsHTML += `<td>${formattedDateTime}</td>`;
                                }else {
                                    if (i === 4)
                                        if (parseFloat(cell) > 0){
                                            //alert('Subtotal: ' + cell);    
                                            rowsHTML += `<td>FAC</td>`; // Elimina la celda si subtotal <= 0
                                        }
                                        else
                                            rowsHTML += `<td>NC</td>`; // Agrega la celda si subtotal > 0
                                    rowsHTML += `<td>${cell !== null ? cell : ''}</td>`; // Manejar valores nulos
                                }
                                
                                i++;
                            });
                            rowsHTML += '</tr>';
                        });
                        excelTableBody.innerHTML = rowsHTML; // Inserta todas las filas en el tbody
                    } else {
                        errorMessageDiv.innerHTML = '<p class="text-info">El archivo se procesó, pero no se encontraron datos válidos después de los filtros.</p>';
                    }

                } catch (error) {
                    console.error('Error al cargar o procesar el archivo:', error);
                    errorMessageDiv.innerHTML = `<p>Error: ${error.message}</p>`;
                    loadingSpinner.style.display = 'none';
                }
            } else {
                errorMessageDiv.innerHTML = '<p>Por favor, selecciona un archivo antes de hacer clic en "Cargar Información".</p>';
            }
        });

        // Función para obtener el token CSRF (si lo necesitas)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('guardar-btn').addEventListener('click', async () => {
            const tabla  = document.getElementById('tabla-datos');
            const filas  = tabla.tBodies[0].rows;
            const datos  = [];
            errorMessageDiv.innerHTML = '';

            for (let i = 0; i < filas.length; i++) {
                const celdas = filas[i].cells;
                const fila   = [];

                for (let j = 0; j < celdas.length; j++) {
                    let valor = celdas[j].innerText.trim();

                    // Quita $ y separadores de miles (,) para que el backend reciba “1234.56”
                    if (valor.startsWith('$')) {
                        valor = valor.replace('$', '').replaceAll(',', '');
                    }
                    fila.push(valor);
                }
                datos.push(fila);
            }

            // CSRF para Django
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            //alert('Datos a guardar: ' + JSON.stringify(datos));
            try {
                // Ruta base del sitio
                const basePath = window.location.origin;

                // O si estás en una subruta, obtén la raíz relativa:
                const currentPath = window.location.pathname;  // por ejemplo: /api/invoice_excel/
                const endpoint = currentPath + `/api/guardar/`;
                const resp = await fetch(`/api/guardar/`, {
                    method : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken' : csrfToken
                    },
                    body: JSON.stringify({ datos })
                });

                let json;
                try {
                    json = await resp.json();
                } catch (e) {
                    json = {};
                }

                if (!resp.ok) {
                    const errorMsg = json.error || json.mensaje || 'Error desconocido del servidor.';
                    //alert(`(${resp.status}) ${errorMsg}`);
                    errorMessageDiv.innerHTML = `<p>${errorMsg}</p>`;
                    throw new Error(errorMsg);
                }
                
                errorMessageDiv.innerHTML = `<p>Datos Guardados Exitosamente</p>`;
            } catch (err) {
                console.error(err);
                //alert('Error inesperado. Revisa la consola. [' + (err.message || '') + ']');
                /* errorMessageDiv.innerHTML = '<p>Por favor, selecciona un archivo antes de hacer clic en "Cargar Información".</p>'; */
            }
        });
    </script>
</body>
</html>
